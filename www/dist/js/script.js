var ENTER_KEY=13;var ESC_KEY=27;var LEFT_ARROW_KEY=37;var TOP_ARROW_KEY=38;var RIGHT_ARROW_KEY=39;var DOWN_ARROW_KEY=40;var app={omtg:{},msgs:{DELETE_CONNECTION:"This connection will be detached. There is no undo. Are you sure?",DELETE_DIAGRAM:"This diagram will be removed. All its connection will be detached. There is no undo. Are you sure?",EMPTY_PROJECT:"Project is empty, there is nothing to export!",NOT_EMPTY_PROJECT:"Project is not empty"}};$(function(){"use strict";app.diagramsTools=new app.Tools([{name:"polygon",model:"omtgDiagram",tooltip:"Polygon",icon:"imgs/omtg/polygon.png"},{name:"line",model:"omtgDiagram",tooltip:"Line",icon:"imgs/omtg/line.png"},{name:"point",model:"omtgDiagram",tooltip:"Point",icon:"imgs/omtg/point.png"},{name:"node",model:"omtgDiagram",tooltip:"Node",icon:"imgs/omtg/node.png"},{name:"isolines",model:"omtgDiagram",tooltip:"Isolines",icon:"imgs/omtg/isolines.png"},{name:"planar-subdivision",model:"omtgDiagram",tooltip:"Planar Subdivision",icon:"imgs/omtg/planar-subdivision.png"},{name:"TIN",model:"omtgDiagram",tooltip:"Triangular Irregular Network",icon:"imgs/omtg/TIN.png"},{name:"tesselation",model:"omtgDiagram",tooltip:"Tesselation",icon:"imgs/omtg/tesselation.png"},{name:"sample",model:"omtgDiagram",tooltip:"Sample",icon:"imgs/omtg/sample.png"},{name:"un-line",model:"omtgDiagram",tooltip:"Unidirectional Line",icon:"imgs/omtg/un-line.png"},{name:"bi-line",model:"omtgDiagram",tooltip:"Bidirectional Line",icon:"imgs/omtg/bi-line.png"},{name:"conventional",model:"omtgDiagram",tooltip:"Conventional",icon:"imgs/omtg/conventional.png"}]);app.relationsTools=new app.Tools([{name:"association",model:"omtgRelation",tooltip:"Association",icon:"imgs/relation/association.png"},{name:"spatial-association",model:"omtgRelation",tooltip:"Spatial Association",icon:"imgs/relation/spatial-association.png"},{name:"aggregation",model:"omtgRelation",tooltip:"Aggregation",icon:"imgs/relation/aggregation.png"},{name:"spatial-aggregation",model:"omtgRelation",tooltip:"Spatial Aggregation",icon:"imgs/relation/spatial-aggregation.png"},{name:"cartographic-generalization-overlapping",model:"omtgRelation",tooltip:"Cartographic Generalization Overlapping",icon:"imgs/relation/cartographic-generalization-overlapping.png"},{name:"cartographic-generalization-disjoint",model:"omtgRelation",tooltip:"Cartographic Generalization Disjoint",icon:"imgs/relation/cartographic-generalization-disjoint.png"},{name:"generalization-disjoint-partial",model:"omtgRelation",tooltip:"Generalization Disjoint-Partial",icon:"imgs/relation/generalization-disjoint-partial.png"},{name:"generalization-overlapping-partial",model:"omtgRelation",tooltip:"Generalization Overlapping-Partial",icon:"imgs/relation/generalization-overlapping-partial.png"},{name:"generalization-disjoint-total",model:"omtgRelation",tooltip:"Generalization Disjoint-Total",icon:"imgs/relation/generalization-disjoint-total.png"},{name:"generalization-overlapping-total",model:"omtgRelation",tooltip:"Generalization Overlapping-Total",icon:"imgs/relation/generalization-overlapping-total.png"},{name:"arc-network",model:"omtgRelation",tooltip:"Arc Network",icon:"imgs/relation/arc-network.png"}]);app.toolboxes=new app.Toolboxes([{name:"Diagrams",tools:app.diagramsTools},{name:"Relations",tools:app.relationsTools}]);app.canvas=new app.Canvas;app.aboutView=new app.AboutView;app.navbarView=new app.NavbarView({el:$("#navbar")});app.toolboxesView=new app.ToolboxesView({el:$("#section-sidebar"),model:app.toolboxes});app.canvasView=new app.CanvasView({el:"#canvas",model:app.canvas})});jsPlumb.ready(function(){var e={strokeStyle:"black",lineWidth:2,outlineColor:"transparent",outlineWidth:4};var t={strokeStyle:"black",lineWidth:2,outlineColor:"transparent",outlineWidth:4,dashstyle:"4"};var a={lineWidth:4,strokeStyle:"#1e8151",outlineWidth:2,outlineColor:"white"};var i=[["Diamond",{length:35,width:18,location:35,paintStyle:{strokeStyle:"black",fillStyle:"white"}}]];var n=function(e){if(e=="generalization-disjoint-partial")return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}];if(e=="generalization-overlapping-partial")return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}];if(e=="generalization-disjoint-total")return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}];if(e=="generalization-overlapping-total")return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]};var o=function(e,t){return["Custom",{create:function(t){return $('<svg class="generalization-triangle" height="26" width="26"><polygon points="1,25 13,1 25,25" stroke="black" stroke-width="1" fill="'+e+'" /></svg>')},location:t,id:"generalization-triangle"}]};var r=function(e){return["Custom",{create:function(e){return $('<svg width="16px" height="16px"><circle cx="8" cy="8" r="8" stroke="black" stroke-width="0" fill="black" /></svg>')},location:e}]};var s=function(e,t){return["Custom",{create:function(t){return $('<svg class="cartographic-square" width="16px" height="16px"><rect width="15px" height="15px"  stroke="black" stroke-width="2" fill="'+e+'" /></svg>')},id:"cartographic-square",location:t}]};app.plumb=jsPlumb.getInstance({Anchor:"Continuous",ConnectionsDetachable:false,Connector:"Flowchart",Container:"canvas",DragOptions:{cursor:"pointer",zIndex:2e3},Endpoint:"Blank",HoverPaintStyle:a});app.plumb.registerConnectionTypes({association:{paintStyle:e,overlays:[["Label",{label:"",location:.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"",location:45,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"",location:-45,id:"cardinality-labelB",cssClass:"cardinality-label"}]],parameters:{minA:"",maxA:"",minB:"",maxB:""}},"spatial-association":{paintStyle:t,overlays:[["Label",{label:"",location:.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"",location:45,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"",location:-45,id:"cardinality-labelB",cssClass:"cardinality-label"}]],parameters:{minA:"",maxA:"",minB:"",maxB:""}},aggregation:{paintStyle:e,overlays:i},"spatial-aggregation":{paintStyle:t,overlays:i},"generalization-disjoint-partial":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:e,overlays:[o("white",13)],parameters:{participation:"partial",disjointness:"disjoint"}},"generalization-overlapping-partial":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:e,overlays:[o("black",13)],parameters:{participation:"partial",disjointness:"overlapping"}},"generalization-disjoint-total":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:e,overlays:[r(9),o("white",30)],parameters:{participation:"total",disjointness:"disjoint"}},"generalization-overlapping-total":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:e,overlays:[r(9),o("black",30)],parameters:{participation:"total",disjointness:"overlapping"}},"generalization-leg":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:e},"arc-network":{connector:"Straight",paintStyle:t,overlays:[["Label",{label:"network",location:.5,id:"description-label",cssClass:"arc-network-label"}]]},"arc-network-sibling":{connector:"Straight",paintStyle:t},"arc-network-self":{connector:["Flowchart",{stub:[50,50],alwaysRespectStubs:true}],paintStyle:t,overlays:[["Label",{label:"network",location:.4,id:"description-label",cssClass:"arc-network-label"}]]},"arc-network-sibling-self":{connector:["Flowchart",{stub:[25,25],alwaysRespectStubs:true}],paintStyle:t},"cartographic-generalization-disjoint":{connector:["Flowchart",{stub:[70,50],alwaysRespectStubs:true}],paintStyle:t,overlays:[s("white",70),["Label",{label:"scale",location:.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"disjoint"}},"cartographic-generalization-overlapping":{connector:["Flowchart",{stub:[70,50],alwaysRespectStubs:true}],paintStyle:t,overlays:[s("black",70),["Label",{label:"scale",location:.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"overlapping"}},"cartographic-leg":{connector:["Flowchart",{stub:[0,50],alwaysRespectStubs:true}],paintStyle:t}});app.plumb.bind("connectionDrag",function(e){var t=app.canvas.get("activeTool");if(t&&t.get("model")=="omtgRelation"){e.setType(t.get("name"));return}if(e.source.classList[0]=="cartographic-square"){e.setType("cartographic-leg")}});app.plumb.bind("connection",function(e,t){var a=e.connection.getType()[0];switch(a){case"arc-network":if(e.connection.sourceId==e.connection.targetId){app.plumb.detach(e.connection);var i=app.plumb.connect({source:e.connection.sourceId,target:e.connection.targetId,anchors:[[.35,1,0,1],[1,.5,1,0]],type:"arc-network-self",fireEvent:false});var o=app.plumb.connect({source:e.connection.sourceId,target:e.connection.targetId,anchors:[[.5,1,0,1],[1,.75,1,0]],type:"arc-network-sibling-self",parameters:{sibling:i},fireEvent:false});i.setParameter("sibling",o)}else{var o=app.plumb.connect({source:e.connection.sourceId,target:e.connection.targetId,type:"arc-network-sibling",parameters:{sibling:e.connection},fireEvent:false});e.connection.setParameter("sibling",o)}break;case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var r=e.connection.getParameter("participation");var s=e.connection.getParameter("disjointness");app.plumb.detach(e.connection);var l=app.plumb.addEndpoint(e.connection.sourceId,{anchor:[.5,1.2,0,1],connectionType:"generalization-leg",endpoint:n(a),isSource:true,isTarget:false,maxConnections:100,uniqueEndpoint:true,parameters:{participation:r,disjointness:s}});var i=app.plumb.connect({anchors:["Bottom","Top"],source:l,target:e.connection.targetId,type:a,fireEvent:false});i.removeAllOverlays();break;case"generalization-leg":e.connection.endpoints[1].setAnchor("Top");break;case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":app.plumb.detach(e.connection);var i=app.plumb.connect({source:e.connection.sourceId,target:e.connection.targetId,anchors:["Bottom","Top"],type:a,fireEvent:false});app.plumb.makeSource(i.getOverlay("cartographic-square").getElement());break;case"cartographic-leg":e.connection.endpoints[1].setAnchor("Top");break}});app.plumb.bind("beforeDrop",function(e){var t=e.connection.getType()[0];if(t!="arc-network"&&e.sourceId==e.targetId){return false}var a=app.canvas.get("diagrams").get(e.sourceId,"type");var i=app.canvas.get("diagrams").get(e.targetId,"type");switch(t){case"generalization-disjoint-partial":case"generalization-overlapping-partial":case"generalization-disjoint-total":case"generalization-overlapping-total":return a==i;case"aggregation":return a=="conventional"||i=="conventional";case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":return a=="conventional"&&i!="conventional";case"cartographic-leg":return i!="conventional";case"spatial-association":case"spatial-aggregation":return a!="conventional"&&i!="conventional";case"arc-network":return a==i&&(a=="node"||a=="bi-line"||a=="un-line")||a=="node"&&(i=="bi-line"||i=="un-line")||i=="node"&&(a=="bi-line"||a=="un-line")}return true});app.plumb.bind("dblclick",function(e,t){var a=e;if(e instanceof jsPlumb.Overlays.Label)a=e.component;var i=a.getType()[0];if(i=="arc-network-sibling"||i=="arc-network-sibling-self")a=a.getParameter("sibling");if(i=="aggregation"||i=="spatial-aggregation"||i=="cartographic-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){app.plumb.detach(a)}}else if(i=="generalization-disjoint-partial"||i=="generalization-disjoint-total"||i=="generalization-overlapping-partial"||i=="generalization-overlapping-total"){if(confirm(app.msgs.DELETE_CONNECTION)){var n=a.endpoints[0];app.plumb.detach(a);if(n.getAttachedElements().length==0){app.plumb.deleteEndpoint(n)}else{n.getAttachedElements()[0].setType(i);n.getAttachedElements()[0].removeAllOverlays()}}}else if(i=="generalization-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){var n=a.endpoints[0];app.plumb.detach(a);if(n.getAttachedElements().length==0){app.plumb.deleteEndpoint(n)}}}else{new app.omtg.ConnectionEditorView({connection:a})}})});"use strict";app.XMLParser={parseOMTGSchema:function(e){app.plumb.setSuspendDrawing(true);var t=new DOMParser;var a=t.parseFromString(e,"text/xml");this.diagramMap={};var i=a.getElementsByTagName("classes")[0].childNodes;var n=a.getElementsByTagName("relationships")[0].childNodes;this.parseOMTGDiagrams(i);this.parseOMTGConnections(n);app.plumb.setSuspendDrawing(false,true)},parseOMTGDiagrams:function(e){for(var t=0;t<e.length;t++){var a=e.item(t);var i=this.parseOMTGDiagram(a);app.canvas.get("diagrams").add(i)}},parseOMTGDiagram:function(e){var t=e.childNodes;var a=new app.omtg.Diagram;for(var i=0;i<t.length;i++){switch(t.item(i).nodeName){case"name":a.set("name",t.item(i).firstChild.nodeValue);break;case"top":a.set("top",parseFloat(t.item(i).firstChild.nodeValue));break;case"left":a.set("left",parseFloat(t.item(i).firstChild.nodeValue));break;case"type":a.set("type",t.item(i).firstChild.nodeValue);break;case"attributes":a.set("attributes",this.parseOMTGAttributes(t.item(i)));break}}this.diagramMap[a.get("name")]=a.get("id");return a},parseOMTGAttributes:function(e){var t=e.childNodes;var a=new app.omtg.Attributes;for(var i=0;i<t.length;i++){var n=this.parseOMTGAttribute(t.item(i));a.add(n)}return a},parseOMTGAttribute:function(e){var t=e.childNodes;var a=new app.omtg.Attribute;for(var i=0;i<t.length;i++){switch(t.item(i).nodeName){case"id":a.set("id",t.item(i).firstChild.nodeValue);break;case"name":a.set("name",t.item(i).firstChild.nodeValue);break;case"type":a.set("type",t.item(i).firstChild.nodeValue);break;case"default":a.set("defaultValue",t.item(i).firstChild.nodeValue);break;case"key":a.set("isKey",t.item(i).firstChild.nodeValue);break;case"length":a.set("length",t.item(i).firstChild.nodeValue);break;case"scale":a.set("scale",t.item(i).firstChild.nodeValue);break;case"size":a.set("size",t.item(i).firstChild.nodeValue);break;case"not-null":a.set("isNotNull",t.item(i).firstChild.nodeValue);break;case"domain":a.set("domain",this.parseOMTGAttributeDomain(t.item(i)));break}}return a},parseOMTGAttributeDomain:function(e){return null},parseOMTGConnections:function(e){for(var t=0;t<e.length;t++){var a=e.item(t);this.parseOMTGConnection(a)}},parseOMTGConnection:function(e){switch(e.nodeName){case"conventional":var t=this.getValue(e.childNodes[0].firstChild);var a=e.childNodes[1].firstChild.nodeValue;var i=e.childNodes[3].firstChild.nodeValue;var n=e.childNodes[2];var o=e.childNodes[4];var r=app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],type:"association"});r.getOverlay("description-label").setLabel(t);this.parseOMTGConnectionCardinality(n,r,"A");this.parseOMTGConnectionCardinality(o,r,"B");break;case"topological":var t=this.getValue(e.childNodes[0].firstChild.firstChild);var a=e.childNodes[1].firstChild.nodeValue;var i=e.childNodes[3].firstChild.nodeValue;var n=e.childNodes[2];var o=e.childNodes[4];var r=app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],type:"spatial-association"});r.getOverlay("description-label").setLabel(t);this.parseOMTGConnectionCardinality(n,r,"A");this.parseOMTGConnectionCardinality(o,r,"B");break;case"conventional-aggregation":var a=e.childNodes[0].firstChild.nodeValue;var i=e.childNodes[1].firstChild.nodeValue;app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],type:"aggregation"});break;case"spatial-aggregation":var a=e.childNodes[0].firstChild.nodeValue;var i=e.childNodes[1].firstChild.nodeValue;app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],type:"spatial-aggregation"});break;case"network":var t=this.getValue(e.childNodes[0].firstChild);var a=e.childNodes[1].firstChild.nodeValue;var i=e.childNodes[2].firstChild.nodeValue;var s="arc-network";var l="arc-network-sibling";var c=["Continuous","Continuous"];var p=["Continuous","Continuous"];if(a==i){s="arc-network-self";l="arc-network-sibling-self";c=[[.35,1,0,1],[1,.5,1,0]];p=[[.5,1,0,1],[1,.75,1,0]]}var r=app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],anchors:c,type:s,fireEvent:false});var g=app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],anchors:p,type:l,parameters:{sibling:r},fireEvent:false});r.setParameter("sibling",g);r.getOverlay("description-label").setLabel(t);break;case"conceptual-generalization":var a=e.childNodes[0].firstChild.nodeValue;var d=e.childNodes[2].firstChild.nodeValue;var i=e.childNodes[3].childNodes[0].firstChild.nodeValue;var m=e.childNodes[3].childNodes;var r=app.plumb.connect({source:this.diagramMap[a],target:this.diagramMap[i],anchors:["Bottom","Top"],type:"cartographic-generalization-"+d,fireEvent:false});var u=r.getOverlay("cartographic-square").getElement();app.plumb.makeSource(u);for(var h=1;h<m.length;h++){app.plumb.connect({source:u,target:this.diagramMap[m[h].firstChild.nodeValue],type:"cartographic-leg"})}break;case"generalization":var a=e.childNodes[0].firstChild.nodeValue;var v=e.childNodes[1].firstChild.nodeValue;var d=e.childNodes[2].firstChild.nodeValue;var m=e.childNodes[3].childNodes;var s="generalization-"+d+"-"+v;var f=function(e){if(e=="generalization-disjoint-partial")return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}];if(e=="generalization-overlapping-partial")return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}];if(e=="generalization-disjoint-total")return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}];if(e=="generalization-overlapping-total")return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]};var b=app.plumb.addEndpoint(this.diagramMap[a],{anchor:[.5,1.2,0,1],connectionType:"generalization-leg",endpoint:f(s),isSource:true,isTarget:false,maxConnections:100,uniqueEndpoint:true,parameters:{participation:v,disjointness:d}});for(var h=0;h<m.length;h++){app.plumb.connect({source:b,target:this.diagramMap[m[h].firstChild.nodeValue],type:"generalization-leg"})}break}},parseOMTGConnectionCardinality:function(e,t,a){if(a!="A"&&a!="B")return;var i="",n="",o="";i=this.getValue(e.childNodes[0].firstChild);n=this.getValue(e.childNodes[1].firstChild);if(i==""&&n==""){o=""}else if(i!=""&&n!=""){o=i+".."+n}else{o=i+""+n}t.getOverlay("cardinality-label"+a).setLabel(o);t.setParameter("min"+a,i);t.setParameter("max"+a,n)},getValue:function(e){if(e)return e.nodeValue;else return""}};(function(){"use strict";app.Canvas=Backbone.Model.extend({defaults:function(){return{diagrams:new app.omtg.Diagrams,activeTool:null}},toXML:function(){var e='<?xml version="1.0" encoding="UTF-8"?>'+'<omtg-conceptual-schema xsi:noNamespaceSchemaLocation="omtg-schema-template.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+this.get("diagrams").toXML()+this.connectionsToXML()+"</omtg-conceptual-schema>";return e},connectionsToXML:function(){var e=app.plumb.getConnections();var t="";for(var a=0;a<e.length;a++){var i=e[a].getType()[0];if(i!="arc-network-sibling"&&i!="cartographic-leg"&&i!="generalization-leg"){t+=this.connectionToXML(e[a])}}return"<relationships>"+t+"</relationships>"},connectionToXML:function(e){var t=e.getType()[0];switch(t){case"aggregation":var a=this.get("diagrams").get(e.sourceId,"name");var i=this.get("diagrams").get(e.targetId,"name");return"<conventional-aggregation>"+"<class1>"+a+"</class1>"+"<class2>"+i+"</class2>"+"</conventional-aggregation>";case"spatial-aggregation":var a=this.get("diagrams").get(e.sourceId,"name");var i=this.get("diagrams").get(e.targetId,"name");return"<spatial-aggregation>"+"<class1>"+a+"</class1>"+"<class2>"+i+"</class2>"+"</spatial-aggregation>";case"association":var n=e.getOverlay("description-label").getLabel();var a=this.get("diagrams").get(e.sourceId,"name");var i=this.get("diagrams").get(e.targetId,"name");var o=e.getParameter("minA");var r=e.getParameter("maxA");var s=e.getParameter("minB");var l=e.getParameter("maxB");return"<conventional>"+"<name>"+n+"</name>"+"<class1>"+a+"</class1><cardinality1><min>"+o+"</min><max>"+r+"</max></cardinality1>"+"<class2>"+i+"</class2><cardinality2><min>"+s+"</min><max>"+l+"</max></cardinality2>"+"</conventional>";case"spatial-association":var n=e.getOverlay("description-label").getLabel();var a=this.get("diagrams").get(e.sourceId,"name");var i=this.get("diagrams").get(e.targetId,"name");var o=e.getParameter("minA");var r=e.getParameter("maxA");var s=e.getParameter("minB");var l=e.getParameter("maxB");return"<topological>"+"<spatial-relations><spatial-relation>"+n+"</spatial-relation></spatial-relations>"+"<class1>"+a+"</class1><cardinality1><min>"+o+"</min><max>"+r+"</max></cardinality1>"+"<class2>"+i+"</class2><cardinality2><min>"+s+"</min><max>"+l+"</max></cardinality2>"+"</topological>";case"arc-network":case"arc-network-self":var n=e.getOverlay("description-label").getLabel();var a=this.get("diagrams").get(e.sourceId,"name");var i=this.get("diagrams").get(e.targetId,"name");return"<network>"+"<name>"+n+"</name>"+"<class1>"+a+"</class1>"+"<class2>"+i+"</class2>"+"</network>";case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var c=this.get("diagrams").get(e.sourceId,"name");var p=e.endpoints[0];var g=p.getParameter("participation");var d=p.getParameter("disjointness");var m="";var u=p.getAttachedElements();for(var h=0;h<u.length;h++){var v=this.get("diagrams").get(u[h].targetId,"name");m+="<subclass>"+v+"</subclass>"}return"<generalization>"+"<superclass>"+c+"</superclass>"+"<participation>"+g+"</participation>"+"<disjointness>"+d+"</disjointness>"+"<subclasses>"+m+"</subclasses>"+"</generalization>";case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":var c=this.get("diagrams").get(e.sourceId,"name");var d=e.getParameter("disjointness");var n=e.getOverlay("cartographic-label").getLabel();var m="<subclass>"+this.get("diagrams").get(e.targetId,"name")+"</subclass>";var u=app.plumb.getConnections({source:e.getOverlay("cartographic-square").getElement()});for(var h=0;h<u.length;h++){var v=this.get("diagrams").get(u[h].targetId,"name");m+="<subclass>"+v+"</subclass>"}return"<conceptual-generalization>"+"<superclass>"+c+"</superclass>"+"<scale-shape>"+n+"</scale-shape>"+"<disjointness>"+d+"</disjointness>"+"<subclasses>"+m+"</subclasses>"+"</conceptual-generalization>";default:return""}}})})();(function(){"use strict";app.Toolbox=Backbone.Model.extend({defaults:function(){return{name:"",tools:null}}})})();(function(){"use strict";app.Tool=Backbone.Model.extend({defaults:function(){return{name:"",type:"",tooltip:"",icon:"",active:false}},toggleActive:function(){this.set("active",!this.get("active"))}})})();(function(){"use strict";app.omtg.Attribute=Backbone.Model.extend({defaults:function(){return{name:"",type:"Varchar",defaultValue:"",isKey:false,length:"",scale:"",size:"",isNotNull:false,domain:""}},toXML:function(){var e="<attribute>";e+="<name>"+this.get("name")+"</name>";e+="<type>"+this.get("type")+"</type>";if(this.get("isKey"))e+="<key>"+this.get("isKey")+"</key>";if(this.get("length")!="")e+="<length>"+this.get("length")+"</length>";if(this.get("scale")!="")e+="<scale>"+this.get("scale")+"</scale>";if(this.get("isNotNull"))e+="<not-null>"+this.get("isNotNull")+"</not-null>";if(this.get("defaultValue")!="")e+="<default>"+this.get("defaultValue")+"</default>";if(this.get("size")!="")e+="<size>"+this.get("size")+"</size>";if(this.get("domain")!=""){e+="<domain>";var t=this.domain.split("\n");for(var a=0;a<t.length;a++){e+="<value>"+t[a]+"</value>"}e+="</domain>"}e+="</attribute>";return e}})})();(function(){"use strict";app.omtg.Diagram=Backbone.Model.extend({defaults:function(){return{id:this.cid,type:"",name:"Class "+this.cid,attributes:new app.omtg.Attributes,selected:false,top:10,left:10,deleted:false}},toggleSelected:function(){this.set("selected",!this.get("selected"))},toXML:function(){return"<class>"+"<name>"+this.get("name")+"</name>"+"<top>"+this.get("top")+"</top>"+"<left>"+this.get("left")+"</left>"+"<type>"+this.get("type")+"</type>"+"<attributes>"+this.get("attributes").toXML()+"</attributes>"+"</class>"}})})();(function(){"use strict";app.Toolboxes=Backbone.Collection.extend({model:app.Toolbox})})();(function(){"use strict";app.Tools=Backbone.Collection.extend({model:app.Tool,initialize:function(){this.listenTo(this,"change:active",this.propagate_active)},propagate_active:function(e){if(!e.get("active"))return;this.each(function(t){if(e.get("name")!=t.get("name"))t.set({active:false},{silent:false})})},deactivateAll:function(){this.each(function(e){e.set({active:false},{silent:false})})},activated:function(){return this.findWhere({active:true})},getTooltip:function(e){return this.findWhere({name:e}).get("tooltip")}})})();(function(){"use strict";app.omtg.Attributes=Backbone.Collection.extend({model:app.omtg.Attribute,toXML:function(){var e="";this.each(function(t){e+=t.toXML()});return e}})})();(function(){"use strict";app.omtg.Diagrams=Backbone.Collection.extend({model:app.omtg.Diagram,initialize:function(){this.listenTo(this,"change:selected",this.propagate_selected)},propagate_selected:function(e){if(!e.get("selected"))return;this.each(function(t){if(e.id!=t.id)t.set({selected:false},{silent:false})})},unselectAll:function(){this.each(function(e){e.set({selected:false},{silent:false})})},get:function(e,t){var a=this.findWhere({id:e});if(a)return a.get(t);return null},toXML:function(){var e="";this.each(function(t){if(!t.get("deleted"))e+=t.toXML()});return"<classes>"+e+"</classes>"}})})();(function(e){"use strict";app.AboutView=Backbone.View.extend({id:"welcome-modal",className:"modal fade",events:{"hidden.bs.modal":"teardown"},initialize:function(t){this.template=_.template(e("#about-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:true,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()}})})(jQuery);(function(e){"use strict";app.NavbarView=Backbone.View.extend({events:{"click #btnImportXML":"importXML","click #btnExportXML":"exportXML","click #btnExportSQL":"exportSQL","click #btnPrint":"print","click #btnAbout":"showAbout"},importXML:function(){if(app.canvas.get("diagrams").length>0){alert(app.msgs.NOT_EMPTY_PROJECT);return}new app.XMLImporterView},exportXML:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var e=app.canvas.toXML();var t=new Blob([e]);saveAs(t,"OMTG.xml")},false)},exportSQL:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var t=app.canvas.toXML();e.ajax({url:"omtg2sql",type:"POST",data:t,contentType:"application/json; charset=UTF-8",success:function(e,t,a){var i=new Uint8Array(e.length);for(var n=0;n<e.length;n++){i[n]=e.charCodeAt(n)&255}var o=new Blob([i]);saveAs(o,"OMTG.zip")},error:function(e,t,a){alert("The request failed.")}})},false)},print:function(){app.canvasView.print()},showAbout:function(){new app.AboutView}})})(jQuery);(function(e){"use strict";app.ToolboxView=Backbone.View.extend({tagName:"div",className:"widget",initialize:function(){this.template=_.template(e("#toolbox-template").html())},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=new app.ToolsView({model:this.model.get("tools")});e.$el=this.$(".widget-content");e.render();return this}})})(jQuery);(function(e){"use strict";app.ToolView=Backbone.View.extend({events:{click:"clicked"},initialize:function(){this.template=_.template(e("#tool-template").html());this.listenTo(this.model,"change:active",this.toggle)},render:function(){var e=this.template(this.model.toJSON());this.setElement(e);return this},clicked:function(){this.model.toggleActive()},toggle:function(){if(this.model.get("active")){this.$el.addClass("active");app.canvas.set("activeTool",this.model)}else{this.$el.removeClass("active");app.canvas.set("activeTool",null)}}})})(jQuery);(function(e){"use strict";app.CanvasView=Backbone.View.extend({events:{click:"clicked"},initialize:function(){this.listenTo(this.model.get("diagrams"),"add",this.addOMTGDiagram);this.listenTo(this.model,"change:activeTool",this.setCursor)},clicked:function(e){var t=this.model.get("activeTool");if(t){if(t.get("model")=="omtgDiagram"){var a=new app.omtg.Diagram({type:t.get("name"),left:e.offsetX,top:e.offsetY});this.model.get("diagrams").add(a)}t.toggleActive();this.model.set("activeTool",null)}this.model.get("diagrams").unselectAll()},setCursor:function(){var e=this.model.get("activeTool");if(e&&e.get("model")=="omtgDiagram"){this.$el.css("cursor","copy")}else{this.$el.css("cursor","default")}},addOMTGDiagram:function(t){app.plumb.setSuspendDrawing(true);var a=new app.omtg.DiagramView({model:t});var i=a.render().el;this.$el.append(i);app.plumb.makeSource(i,{filter:function(){var e=app.canvas.get("activeTool");if(e&&e.get("model")=="omtgRelation")return true;return false}});app.plumb.makeTarget(i);app.plumb.draggable(i,{containment:"#canvas",scroll:true,drag:function(t,a){if(e(".cartographic-square").length>0)app.plumb.repaintEverything()}});app.plumb.setSuspendDrawing(false,true)},print:function(){}})})(jQuery);(function(e){"use strict";app.ToolboxesView=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.empty();this.model.each(function(e){var t=new app.ToolboxView({model:e});this.$el.append(t.render().el)},this)}})})(jQuery);(function(e){"use strict";app.ToolsView=Backbone.View.extend({render:function(){this.$el.empty();this.model.each(function(e){var t=new app.ToolView({model:e});this.$el.append(t.render().el)},this);return this}})})(jQuery);(function(e){"use strict";app.XMLImporterView=Backbone.View.extend({id:"xml-importer",className:"modal fade",events:{"click #btnImport":"import","hidden.bs.modal":"teardown","change #js-upload-files":"uploadFile","load #js-upload-files":"import"},initialize:function(t){this.template=_.template(e("#xmlimporter-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},uploadFile:function(t){var a=t.target.files[0];var i=new FileReader;var n=this;i.readAsText(a);i.onload=function(){e.ajax({url:"XMLImporter",type:"POST",data:i.result,contentType:"application/json; charset=UTF-8",complete:function(e,t,a){n.allowImport(e.status);n.validXML=i.result}})}},"import":function(){var e=app.XMLParser;e.parseOMTGSchema(this.validXML);this.teardown()},allowImport:function(e){if(e==202){this.$("#btnImport").removeClass("disabled")}else{this.$("#btnImport").addClass("disabled")}}})})(jQuery);(function(e){"use strict";app.omtg.AttributeView=Backbone.View.extend({tagName:"tr",initialize:function(){this.template=_.template("<td><% if( isKey ){ %> <img class='attribute-key' src='imgs/omtg/key.png'> <% } %></td><td><%= attr %></td>")},render:function(){this.$el.html(this.template({isKey:this.model.get("isKey"),attr:this.model.escape("name")+": "+this.model.get("type")}));return this}})})(jQuery);(function(e){"use strict";app.omtg.ConnectionEditorView=Backbone.View.extend({id:"connection-editor",className:"modal fade",events:{"click #btnUpdate":"update","click #btnDelete":"detach","hidden.bs.modal":"teardown"},initialize:function(t){this.template=_.template(e("#omtg-connection-editor-template").html());this.connection=t.connection;this.render()},render:function(){this.$el.html(this.template());var t=this.$("#connection-editor-form > fieldset");var a=this.connection.getType()[0];
if(a=="association"||a=="spatial-association"||a=="arc-network"||a=="arc-network-self"){t.append(_.template(e("#omtg-connection-editor-description-template").html()));this.descriptionLabel=this.connection.getOverlay("description-label");this.$("#inputConnectionDescription").val(this.descriptionLabel.getLabel())}if(a=="association"||a=="spatial-association"){t.append(_.template(e("#omtg-connection-editor-cardinalities-template").html()));this.cardLabelA=this.connection.getOverlay("cardinality-labelA");this.$("#inputMinA").val(this.connection.getParameter("minA"));this.$("#inputMaxA").val(this.connection.getParameter("maxA"));this.cardLabelB=this.connection.getOverlay("cardinality-labelB");this.$("#inputMinB").val(this.connection.getParameter("minB"));this.$("#inputMaxB").val(this.connection.getParameter("maxB"))}if(a=="cartographic-generalization-disjoint"||a=="cartographic-generalization-overlapping"){t.append(_.template(e("#omtg-connection-editor-cartographic-template").html()));this.cartographicLabel=this.connection.getOverlay("cartographic-label");if(this.cartographicLabel.getLabel()=="scale")this.$("#scaleRadio").prop("checked",true);else this.$("#shapeRadio").prop("checked",true)}this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},update:function(){var e=this.connection.getType()[0];if(e=="association"||e=="spatial-association"||e=="arc-network"||e=="arc-network-self"){var t=this.$("#inputConnectionDescription").val().trim();this.descriptionLabel.setLabel(t)}if(e=="association"||e=="spatial-association"){var a=this.$("#inputMinA").val().trim();var i=this.$("#inputMaxA").val().trim();this.cardLabelA.setLabel(this.concatCardLabel(a,i));var n=this.$("#inputMinB").val().trim();var o=this.$("#inputMaxB").val().trim();this.cardLabelB.setLabel(this.concatCardLabel(n,o));this.connection.setParameter("minA",a);this.connection.setParameter("maxA",i);this.connection.setParameter("minB",n);this.connection.setParameter("maxB",o)}if(e=="cartographic-generalization-disjoint"||e=="cartographic-generalization-overlapping"){this.cartographicLabel.setLabel(this.$("input:radio[name=inlineRadioOptions]:checked").val())}this.teardown()},detach:function(e){if(confirm(app.msgs.deleteConnection)){var t=this.connection.getType()[0];if(t=="cartographic-generalization-disjoint"||t=="cartographic-generalization-overlapping"){app.plumb.detachAllConnections(this.connection.getOverlay("cartographic-square").getElement())}app.plumb.detach(this.connection);this.teardown()}},concatCardLabel:function(e,t){if(e==""&&t==""){return""}if(e!=""&&t!=""){return e+".."+t}return e+""+t}})})(jQuery);(function(e){"use strict";app.omtg.DiagramEditorView=Backbone.View.extend({id:"diagram-editor",className:"modal fade",events:{"click #btnUpdate":"updateDiagram","hidden.bs.modal":"teardown","click #ulDiagramType a":"selectType","click #btnAddRow":"newAttribute","click .btnRowDelete":"deleteAttribute","click .btnRowUp":"moveAttributeUp","click .btnRowDown":"moveAttributeDown","blur .name-editable":"editName","blur .value-editable":"editValue","click .toggleKey":"toggleKey","click .toggleNotNull":"toggleNotNull","click .ulAttributeType a":"selectAttributeType"},initialize:function(t){this.template=_.template(e("#omtg-diagram-editor-template").html());this.hasConnections=t.hasConnections;this.attrsClone=this.model.get("attributes").clone();this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.modal({backdrop:"static",keyboard:false,show:true});if(this.hasConnections){this.$("#inputDiagramType").addClass("disabled");this.$("#inputDiagramTypeToggle").addClass("disabled")}this.attrsClone.each(function(e){this.addAttribute(e)},this);return this},teardown:function(){this.$el.data("modal",null);this.remove()},selectType:function(e){var t=this.$(e.currentTarget).html();this.$("#inputDiagramType").html(t);var a=this.$(e.currentTarget).data("type-name");this.$("#inputDiagramType").data("type-name",a)},updateDiagram:function(){var e=this.$("#inputDiagramType").data("type-name");if(e){this.model.set("type",e)}var t=this.$("#inputDiagramName").val().trim();if(t){this.model.set("name",t)}for(var a=0;a<this.attrsClone.length;a++){var i=this.attrsClone.at(a);if(i.get("name")==""){this.attrsClone.remove(i);a--}}this.model.set({attributes:this.attrsClone});this.model.trigger("change",this.model);this.teardown()},newAttribute:function(){var e=new app.omtg.Attribute;this.addAttribute(e);this.attrsClone.add(e)},addAttribute:function(t){var a=_.template(e("#omtg-attribute-row-editor-template").html());var i=a(t.toJSON());this.$("#attrTable > tbody > tr:last").before(i)},deleteAttribute:function(e){var t=this.$(e.currentTarget).closest("tr");this.attrsClone.remove(this.attrsClone.at(t.index()));t.remove()},moveAttributeUp:function(e){var t=this.$(e.currentTarget).closest("tr");if(t.index()>0){var a=this.attrsClone.at(t.index());this.attrsClone.remove(a);this.attrsClone.add(a,{at:t.index()-1});t.insertBefore(t.prev())}},moveAttributeDown:function(e){var t=this.$(e.currentTarget).closest("tr");if(t.index()<this.attrsClone.length-1){var a=this.attrsClone.at(t.index()+1);this.attrsClone.remove(a);this.attrsClone.add(a,{at:t.index()});t.insertAfter(t.next())}},editName:function(e,t){var a=this.$(e.currentTarget).closest("tr").index();this.attrsClone.at(a).set("name",this.$(e.currentTarget).text())},editValue:function(e){var t=this.$(e.currentTarget).closest("tr").index();this.attrsClone.at(t).set("defaultValue",this.$(e.currentTarget).text())},toggleKey:function(e){var t=this.$(e.currentTarget).closest("tr").index();this.attrsClone.at(t).set("isKey",this.$(e.currentTarget).prop("checked"))},toggleNotNull:function(e){var t=this.$(e.currentTarget).closest("tr").index();this.attrsClone.at(t).set("isNotNull",this.$(e.currentTarget).prop("checked"))},selectAttributeType:function(e){var t=this.$(e.currentTarget).closest("tr").index();var a=this.$(e.currentTarget).text();this.$(e.currentTarget).parent().parent().siblings("button.btnAttributeType:first").html(a+' <span class="caret"></span>');this.attrsClone.at(t).set("type",a)}})})(jQuery);(function(e){"use strict";app.omtg.DiagramView=Backbone.View.extend({tagName:"div",className:"diagram-container",events:{"click .badge-delete":"delete",click:_.debounce(function(e){if(this.doucleclicked){this.doucleclicked=false}else{this.model.toggleSelected()}},200),dblclick:function(e){this.doucleclicked=true;this.edit.call(this,e)},mouseup:"updatePosition"},initialize:function(){this.$conventional=e("#omtg-conventional-template");this.$georeferenced=e("#omtg-georeferenced-template");this.listenTo(this.model,"change",this.render)},render:function(){if(this.model.get("type")=="conventional"){this.template=_.template(this.$conventional.html())}else{this.template=_.template(this.$georeferenced.html())}this.el.id=this.model.get("id");this.$el.css({top:this.model.get("top"),left:this.model.get("left")});this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("attributes");e.each(function(e){var t=new app.omtg.AttributeView({model:e});this.$(".d-body > table > tbody").append(t.render().el)},this);if(this.model.get("selected")){this.$el.addClass("selected");this.$(".badge-delete").removeClass("hidden")}else{this.$el.removeClass("selected")}app.plumb.repaintEverything();return this},edit:function(){var e=false;if(app.plumb.getConnections({source:this.el.id}).length||app.plumb.getConnections({target:this.el.id}).length)e=true;var t=new app.omtg.DiagramEditorView({model:this.model,hasConnections:e})},"delete":function(){if(confirm(app.msgs.DELETE_DIAGRAM)){app.plumb.detachAllConnections(this.$el);this.model.set("deleted",true);this.remove()}},updatePosition:function(e){this.model.set({left:this.$el.position().left,top:this.$el.position().top})}})})(jQuery);
var ENTER_KEY=13;var ESC_KEY=27;var LEFT_ARROW_KEY=37;var TOP_ARROW_KEY=38;var RIGHT_ARROW_KEY=39;var DOWN_ARROW_KEY=40;var app={omtg:{},msgs:{DELETE_CONNECTION:"This connection will be detached. There is no undo. Are you sure?",DELETE_DIAGRAM:"This diagram will be removed. All its connection will be detached. There is no undo. Are you sure?",EMPTY_PROJECT:"Project is empty, there is nothing to export!",NOT_EMPTY_PROJECT:"Project is not empty"}};$(function(){app.diagramsTools=new app.Tools([{name:"polygon",model:"omtgDiagram",tooltip:"Polygon",icon:"imgs/omtg/polygon.png"},{name:"line",model:"omtgDiagram",tooltip:"Line",icon:"imgs/omtg/line.png"},{name:"point",model:"omtgDiagram",tooltip:"Point",icon:"imgs/omtg/point.png"},{name:"node",model:"omtgDiagram",tooltip:"Node",icon:"imgs/omtg/node.png"},{name:"isolines",model:"omtgDiagram",tooltip:"Isolines",icon:"imgs/omtg/isolines.png"},{name:"planar-subdivision",model:"omtgDiagram",tooltip:"Planar Subdivision",icon:"imgs/omtg/planar-subdivision.png"},{name:"TIN",model:"omtgDiagram",tooltip:"Triangular Irregular Network",icon:"imgs/omtg/TIN.png"},{name:"tesselation",model:"omtgDiagram",tooltip:"Tesselation",icon:"imgs/omtg/tesselation.png"},{name:"sample",model:"omtgDiagram",tooltip:"Sample",icon:"imgs/omtg/sample.png"},{name:"un-line",model:"omtgDiagram",tooltip:"Unidirectional Line",icon:"imgs/omtg/un-line.png"},{name:"bi-line",model:"omtgDiagram",tooltip:"Bidirectional Line",icon:"imgs/omtg/bi-line.png"},{name:"conventional",model:"omtgDiagram",tooltip:"Conventional",icon:"imgs/omtg/conventional.png"}]);app.relationsTools=new app.Tools([{name:"association",model:"omtgRelation",tooltip:"Association",icon:"imgs/relation/association.png"},{name:"spatial-association",model:"omtgRelation",tooltip:"Spatial Association",icon:"imgs/relation/spatial-association.png"},{name:"aggregation",model:"omtgRelation",tooltip:"Aggregation",icon:"imgs/relation/aggregation.png"},{name:"spatial-aggregation",model:"omtgRelation",tooltip:"Spatial Aggregation",icon:"imgs/relation/spatial-aggregation.png"},{name:"cartographic-generalization-overlapping",model:"omtgRelation",tooltip:"Cartographic Generalization Overlapping",icon:"imgs/relation/cartographic-generalization-overlapping.png"},{name:"cartographic-generalization-disjoint",model:"omtgRelation",tooltip:"Cartographic Generalization Disjoint",icon:"imgs/relation/cartographic-generalization-disjoint.png"},{name:"generalization-disjoint-partial",model:"omtgRelation",tooltip:"Generalization Disjoint-Partial",icon:"imgs/relation/generalization-disjoint-partial.png"},{name:"generalization-overlapping-partial",model:"omtgRelation",tooltip:"Generalization Overlapping-Partial",icon:"imgs/relation/generalization-overlapping-partial.png"},{name:"generalization-disjoint-total",model:"omtgRelation",tooltip:"Generalization Disjoint-Total",icon:"imgs/relation/generalization-disjoint-total.png"},{name:"generalization-overlapping-total",model:"omtgRelation",tooltip:"Generalization Overlapping-Total",icon:"imgs/relation/generalization-overlapping-total.png"},{name:"arc-network",model:"omtgRelation",tooltip:"Arc Network",icon:"imgs/relation/arc-network.png"}]);app.toolboxes=new app.Toolboxes([{name:"Diagrams",tools:app.diagramsTools},{name:"Relations",tools:app.relationsTools}]);app.canvas=new app.Canvas();app.navbarView=new app.NavbarView({el:$("#navbar")});app.toolboxesView=new app.ToolboxesView({el:$("#section-sidebar"),model:app.toolboxes});app.canvasView=new app.CanvasView({el:"#canvas",model:app.canvas})});(function(){app.omtg.Attribute=Backbone.Model.extend({defaults:function(){return{name:"",type:"INTEGER",defaultValue:"",isKey:false,length:"",scale:"",size:"",isNotNull:false,domain:""}},toXML:function(){var b="<attribute>";b+="<name>"+this.get("name")+"</name>";b+="<type>"+this.get("type")+"</type>";if(this.get("isKey")){b+="<key>"+this.get("isKey")+"</key>"}if(this.get("length")!=""){b+="<length>"+this.get("length")+"</length>"}if(this.get("scale")!=""){b+="<scale>"+this.get("scale")+"</scale>"}if(this.get("isNotNull")){b+="<not-null>"+this.get("isNotNull")+"</not-null>"}if(this.get("defaultValue")!=""){b+="<default>"+this.get("defaultValue")+"</default>"}if(this.get("size")!=""){b+="<size>"+this.get("size")+"</size>"}if(this.get("domain")!=""){b+="<domain>";var a=this.domain.split("\n");for(var c=0;c<a.length;c++){b+="<value>"+a[c]+"</value>"}b+="</domain>"}b+="</attribute>";return b}})})();(function(){app.omtg.Diagram=Backbone.Model.extend({defaults:function(){return{id:this.cid,type:"",name:"Class_"+this.cid,attributes:new app.omtg.Attributes(),selected:false,top:10,left:10,deleted:false}},toggleSelected:function(){this.set("selected",!this.get("selected"))},toXML:function(){return"<class><name>"+this.get("name")+"</name><top>"+this.get("top")+"</top><left>"+this.get("left")+"</left><type>"+this.get("type")+"</type><attributes>"+this.get("attributes").toXML()+"</attributes></class>"}})})();(function(){app.Tool=Backbone.Model.extend({defaults:function(){return{name:"",type:"",tooltip:"",icon:"",active:false}},toggleActive:function(){this.set("active",!this.get("active"))}})})();(function(){app.Toolbox=Backbone.Model.extend({defaults:function(){return{name:"",tools:null}}})})();(function(){app.Canvas=Backbone.Model.extend({defaults:function(){return{diagrams:new app.omtg.Diagrams(),activeTool:null}},toXML:function(){var a='<?xml version="1.0" encoding="UTF-8"?><omtg-conceptual-schema xsi:noNamespaceSchemaLocation="omtg-schema-template.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+this.get("diagrams").toXML()+this.connectionsToXML()+"</omtg-conceptual-schema>";return a},connectionsToXML:function(){var a=app.plumb.getConnections();var d="";for(var b=0;b<a.length;b++){var c=a[b].getType()[0];if(c!="arc-network-sibling"&&c!="cartographic-leg"&&c!="generalization-leg"){d+=this.connectionToXML(a[b])}}return"<relationships>"+d+"</relationships>"},connectionToXML:function(f){var m=f.getType()[0];switch(m){case"aggregation":var e=this.get("diagrams").get(f.sourceId,"name");var l=this.get("diagrams").get(f.targetId,"name");return"<conventional-aggregation><class1>"+e+"</class1><class2>"+l+"</class2></conventional-aggregation>";case"spatial-aggregation":var e=this.get("diagrams").get(f.sourceId,"name");var l=this.get("diagrams").get(f.targetId,"name");return"<spatial-aggregation><class1>"+e+"</class1><class2>"+l+"</class2></spatial-aggregation>";case"association":var o=f.getOverlay("description-label").getLabel();var e=this.get("diagrams").get(f.sourceId,"name");var l=this.get("diagrams").get(f.targetId,"name");var j=f.getParameter("minA");var b=f.getParameter("maxA");var g=f.getParameter("minB");var a=f.getParameter("maxB");return"<conventional><name>"+o+"</name><class1>"+e+"</class1><cardinality1><min>"+j+"</min><max>"+b+"</max></cardinality1><class2>"+l+"</class2><cardinality2><min>"+g+"</min><max>"+a+"</max></cardinality2></conventional>";case"spatial-association":var o=f.getOverlay("description-label").getLabel();var e=this.get("diagrams").get(f.sourceId,"name");var l=this.get("diagrams").get(f.targetId,"name");var j=f.getParameter("minA");var b=f.getParameter("maxA");var g=f.getParameter("minB");var a=f.getParameter("maxB");return"<topological><spatial-relations><spatial-relation>"+o+"</spatial-relation></spatial-relations><class1>"+e+"</class1><cardinality1><min>"+j+"</min><max>"+b+"</max></cardinality1><class2>"+l+"</class2><cardinality2><min>"+g+"</min><max>"+a+"</max></cardinality2></topological>";case"arc-network":case"arc-network-self":var o=f.getOverlay("description-label").getLabel();var e=this.get("diagrams").get(f.sourceId,"name");var l=this.get("diagrams").get(f.targetId,"name");return"<network><name>"+o+"</name><class1>"+e+"</class1><class2>"+l+"</class2></network>";case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var p=this.get("diagrams").get(f.sourceId,"name");var q=f.endpoints[0];var r=q.getParameter("participation");var d=q.getParameter("disjointness");var c="";var n=q.getAttachedElements();for(var k=0;k<n.length;k++){var h=this.get("diagrams").get(n[k].targetId,"name");c+="<subclass>"+h+"</subclass>"}return"<generalization><superclass>"+p+"</superclass><participation>"+r+"</participation><disjointness>"+d+"</disjointness><subclasses>"+c+"</subclasses></generalization>";case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":var p=this.get("diagrams").get(f.sourceId,"name");var d=f.getParameter("disjointness");var o=f.getOverlay("cartographic-label").getLabel();var c="<subclass>"+this.get("diagrams").get(f.targetId,"name")+"</subclass>";var n=app.plumb.getConnections({source:f.getOverlay("cartographic-square").getElement()});for(var k=0;k<n.length;k++){var h=this.get("diagrams").get(n[k].targetId,"name");c+="<subclass>"+h+"</subclass>"}return"<conceptual-generalization><superclass>"+p+"</superclass><scale-shape>"+o+"</scale-shape><disjointness>"+d+"</disjointness><subclasses>"+c+"</subclasses></conceptual-generalization>";default:return""}}})})();(function(){app.omtg.Attributes=Backbone.Collection.extend({model:app.omtg.Attribute,toXML:function(){var a="";this.each(function(b){a+=b.toXML()});return a}})})();(function(){app.omtg.Diagrams=Backbone.Collection.extend({model:app.omtg.Diagram,initialize:function(){this.listenTo(this,"change:selected",this.propagate_selected)},propagate_selected:function(a){if(!a.get("selected")){return}this.each(function(b){if(a.id!=b.id){b.set({selected:false},{silent:false})}})},unselectAll:function(){this.each(function(a){a.set({selected:false},{silent:false})})},get:function(c,a){var b=this.findWhere({id:c});if(b){return b.get(a)}return null},toXML:function(){var a="";this.each(function(b){if(!b.get("deleted")){a+=b.toXML()}});return"<classes>"+a+"</classes>"}})})();(function(){app.Tools=Backbone.Collection.extend({model:app.Tool,initialize:function(){this.listenTo(this,"change:active",this.propagate_active)},propagate_active:function(a){if(!a.get("active")){return}this.each(function(b){if(a.get("name")!=b.get("name")){b.set({active:false},{silent:false})}});app.canvas.set("activeTool",a)},deactivateAll:function(){this.each(function(a){a.set({active:false},{silent:false})})},activated:function(){return this.findWhere({active:true})},getTooltip:function(a){return this.findWhere({name:a}).get("tooltip")}})})();(function(){app.Toolboxes=Backbone.Collection.extend({model:app.Toolbox})})();(function(a){app.omtg.AttributeView=Backbone.View.extend({tagName:"tr",initialize:function(){this.template=_.template("<td><% if( isKey ){ %> <img class='attribute-key' src='imgs/omtg/key.png'> <% } %></td><td><%= attr %></td>")},render:function(){this.$el.html(this.template({isKey:this.model.get("isKey"),attr:this.model.escape("name")+": "+this.model.get("type")}));return this}})})(jQuery);(function(a){app.omtg.DiagramView=Backbone.View.extend({tagName:"div",className:"diagram-container",events:{"click .badge-delete":"deleteDiagram",click:_.debounce(function(b){if(this.doucleclicked){this.doucleclicked=false}else{this.model.toggleSelected()}},200),dblclick:function(b){this.doucleclicked=true;this.edit.call(this,b)},mouseup:"updatePosition"},initialize:function(){this.$conventional=a("#omtg-conventional-template");this.$georeferenced=a("#omtg-georeferenced-template");this.listenTo(this.model,"change",this.render)},render:function(){if(this.model.get("type")=="conventional"){this.template=_.template(this.$conventional.html())}else{this.template=_.template(this.$georeferenced.html())}this.el.id=this.model.get("id");this.$el.css({top:this.model.get("top"),left:this.model.get("left")});this.$el.html(this.template(this.model.toJSON()));var b=this.model.get("attributes");b.each(function(d){var c=new app.omtg.AttributeView({model:d});this.$(".d-body > table > tbody").append(c.render().el)},this);if(this.model.get("selected")){this.$el.addClass("selected");this.$(".badge-delete").removeClass("hidden")}else{this.$el.removeClass("selected")}app.plumb.repaintEverything();return this},edit:function(){var c=false;if(app.plumb.getConnections({source:this.el.id}).length||app.plumb.getConnections({target:this.el.id}).length){c=true}var b=new app.omtg.DiagramEditorView({model:this.model,hasConnections:c})},deleteDiagram:function(){if(confirm(app.msgs.DELETE_DIAGRAM)){app.plumb.detachAllConnections(this.$el);this.model.set("deleted",true);this.remove()}},updatePosition:function(b){this.model.set({left:this.$el.position().left,top:this.$el.position().top})}})})(jQuery);(function(a){app.omtg.DiagramEditorView=Backbone.View.extend({id:"diagram-editor",className:"modal fade",events:{"click #btnUpdate":"updateDiagram","hidden.bs.modal":"teardown","click #ulDiagramType a":"selectType","input #inputDiagramName":"inputNameChanged","click #btnAddRow":"newAttribute","click .btnRowDelete":"deleteAttribute","click .btnRowUp":"moveAttributeUp","click .btnRowDown":"moveAttributeDown","blur .name-editable":"editName","blur .value-editable":"editValue","blur .length-editable":"editLength","click .toggleKey":"toggleKey","click .toggleNotNull":"toggleNotNull","click .ulAttributeType a":"selectAttributeType",submit:"preventSubmission"},initialize:function(b){this.template=_.template(a("#omtg-diagram-editor-template").html());this.hasConnections=b.hasConnections;this.attrsClone=this.model.get("attributes").clone();this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.modal({backdrop:"static",keyboard:false,show:true});if(this.hasConnections){this.$("#inputDiagramType").addClass("disabled");this.$("#inputDiagramTypeToggle").addClass("disabled")}this.attrsClone.each(function(b){this.addAttribute(b)},this);return this},teardown:function(){this.$el.data("modal",null);this.remove()},selectType:function(d){var c=this.$(d.currentTarget).html();this.$("#inputDiagramType").html(c);var b=this.$(d.currentTarget).data("type-name");this.$("#inputDiagramType").data("type-name",b)},inputNameChanged:function(d){var b=this.$(d.currentTarget).val().trim();var c=new RegExp("[a-zA-Z0-9][w#@]{0,63}$");if(c.test(b)&&/\s/.test(b)==false){this.$("#formDiagramName").removeClass("has-error");this.$("#btnUpdate").removeClass("disabled")}else{this.$("#formDiagramName").addClass("has-error");this.$("#btnUpdate").addClass("disabled")}},updateDiagram:function(){var e=this.$("#inputDiagramType").data("type-name");if(e){this.model.set("type",e)}var c=this.$("#inputDiagramName").val().trim();if(c){this.model.set("name",c)}for(var d=0;d<this.attrsClone.length;d++){var b=this.attrsClone.at(d);if(b.get("name")==""){this.attrsClone.remove(b);d--}}this.model.set({attributes:this.attrsClone});this.model.trigger("change",this.model);this.teardown()},newAttribute:function(){var b=new app.omtg.Attribute();this.addAttribute(b);this.attrsClone.add(b)},addAttribute:function(c){var d=_.template(a("#omtg-attribute-row-editor-template").html());var b=d(c.toJSON());this.$("#attrTable > tbody > tr:last").before(b)},deleteAttribute:function(c){var b=this.$(c.currentTarget).closest("tr");this.attrsClone.remove(this.attrsClone.at(b.index()));b.remove()},moveAttributeUp:function(d){var b=this.$(d.currentTarget).closest("tr");if(b.index()>0){var c=this.attrsClone.at(b.index());this.attrsClone.remove(c);this.attrsClone.add(c,{at:b.index()-1});b.insertBefore(b.prev())}},moveAttributeDown:function(d){var b=this.$(d.currentTarget).closest("tr");if(b.index()<this.attrsClone.length-1){var c=this.attrsClone.at(b.index()+1);this.attrsClone.remove(c);this.attrsClone.add(c,{at:b.index()});b.insertAfter(b.next())}},editName:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("name",this.$(c.currentTarget).text())},editValue:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("defaultValue",this.$(c.currentTarget).text())},editLength:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("length",this.$(c.currentTarget).text())},toggleKey:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("isKey",this.$(c.currentTarget).prop("checked"))},toggleNotNull:function(c){var b=this.$(c.currentTarget).closest("tr").index();this.attrsClone.at(b).set("isNotNull",this.$(c.currentTarget).prop("checked"))},selectAttributeType:function(d){var b=this.$(d.currentTarget).closest("tr").index();var c=this.$(d.currentTarget).text().trim();this.$(d.currentTarget).parent().parent().siblings("button.btnAttributeType:first").html(c+' <span class="caret"></span>');this.attrsClone.at(b).set("type",c);if(c=="VARCHAR"){this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").attr("contenteditable","true")}else{this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").text("");this.$(d.currentTarget).parent().parent().parent().parent().siblings("td.length-editable").attr("contenteditable","false")}},preventSubmission:function(b){b.preventDefault()}})})(jQuery);(function(a){app.omtg.ConnectionEditorView=Backbone.View.extend({id:"connection-editor",className:"modal fade",events:{"click #btnUpdate":"update","click #btnDelete":"detach","hidden.bs.modal":"teardown","click #ulConnectionSpatialRelation a":"selectSpatialRelation",submit:"preventSubmission"},initialize:function(b){this.template=_.template(a("#omtg-connection-editor-template").html());this.connection=b.connection;this.render()},render:function(){this.$el.html(this.template());var b=this.$("#connection-editor-form > fieldset");var c=this.connection.getType()[0];if(c=="spatial-association"){b.append(_.template(a("#omtg-connection-editor-spatial-relation-template").html()));this.descriptionLabel=this.connection.getOverlay("description-label");if(this.descriptionLabel.getLabel()){this.$("#inputConnectionSpatialRelation").data("spatialrelation",this.descriptionLabel.getLabel());this.$("#inputConnectionSpatialRelation").html(this.descriptionLabel.getLabel())}else{this.$("#inputConnectionSpatialRelation").data("spatialrelation","Contains");this.$("#inputConnectionSpatialRelation").html("Contains")}}if(c=="association"||c=="arc-network"||c=="arc-network-self"){b.append(_.template(a("#omtg-connection-editor-description-template").html()));this.descriptionLabel=this.connection.getOverlay("description-label");this.$("#inputConnectionDescription").val(this.descriptionLabel.getLabel())}if(c=="association"||c=="spatial-association"){b.append(_.template(a("#omtg-connection-editor-cardinalities-template").html()));this.cardLabelA=this.connection.getOverlay("cardinality-labelA");this.$("#inputMinA").val(this.connection.getParameter("minA"));this.$("#inputMaxA").val(this.connection.getParameter("maxA"));this.cardLabelB=this.connection.getOverlay("cardinality-labelB");this.$("#inputMinB").val(this.connection.getParameter("minB"));this.$("#inputMaxB").val(this.connection.getParameter("maxB"))}if(c=="cartographic-generalization-disjoint"||c=="cartographic-generalization-overlapping"){b.append(_.template(a("#omtg-connection-editor-cartographic-template").html()));this.cartographicLabel=this.connection.getOverlay("cartographic-label");if(this.cartographicLabel.getLabel()=="scale"){this.$("#scaleRadio").prop("checked",true)}else{this.$("#shapeRadio").prop("checked",true)}}this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},update:function(){var e=this.connection.getType()[0];if(e=="spatial-association"){var d=this.$("#inputConnectionSpatialRelation").data("spatialrelation");if(d){this.descriptionLabel.setLabel(d)}}if(e=="association"||e=="arc-network"||e=="arc-network-self"){var f=this.$("#inputConnectionDescription").val().trim();this.descriptionLabel.setLabel(f)}if(e=="association"||e=="spatial-association"){var c=this.$("#inputMinA").val().trim();var h=this.$("#inputMaxA").val().trim();this.cardLabelA.setLabel(this.concatCardLabel(c,h));var b=this.$("#inputMinB").val().trim();var g=this.$("#inputMaxB").val().trim();this.cardLabelB.setLabel(this.concatCardLabel(b,g));this.connection.setParameter("minA",c);this.connection.setParameter("maxA",h);this.connection.setParameter("minB",b);this.connection.setParameter("maxB",g)}if(e=="cartographic-generalization-disjoint"||e=="cartographic-generalization-overlapping"){this.cartographicLabel.setLabel(this.$("input:radio[name=inlineRadioOptions]:checked").val())}this.teardown()},detach:function(d){if(confirm(app.msgs.deleteConnection)){var c=this.connection.getType()[0];if(c=="cartographic-generalization-disjoint"||c=="cartographic-generalization-overlapping"){app.plumb.detachAllConnections(this.connection.getOverlay("cartographic-square").getElement())}else{if(c=="arc-network"||c=="arc-network-sibling"||c=="arc-network-self"||c=="arc-network-sibling-self"){var b=this.connection.getParameter("sibling");app.plumb.detach(b)}}app.plumb.detach(this.connection);this.teardown()}},concatCardLabel:function(c,b){if(c==""&&b==""){return""}if(c!=""&&b!=""){return c+".."+b}return c+""+b},selectSpatialRelation:function(d){var c=this.$(d.currentTarget).html();this.$("#inputConnectionSpatialRelation").html(c);var b=this.$(d.currentTarget).data("spatialrelation");this.$("#inputConnectionSpatialRelation").data("spatialrelation",b)},preventSubmission:function(b){b.preventDefault()}})})(jQuery);(function(a){app.ToolView=Backbone.View.extend({events:{click:"clicked"},initialize:function(){this.template=_.template(a("#tool-template").html());this.listenTo(this.model,"change:active",this.toggle)},render:function(){var b=this.template(this.model.toJSON());this.setElement(b);return this},clicked:function(){this.model.toggleActive()},toggle:function(){if(this.model.get("active")){this.$el.addClass("active");app.canvas.set("activeTool",this.model)}else{this.$el.removeClass("active");app.canvas.set("activeTool",null)}}})})(jQuery);(function(a){app.ToolsView=Backbone.View.extend({render:function(){this.$el.empty();this.model.each(function(b){var c=new app.ToolView({model:b});this.$el.append(c.render().el)},this);return this}})})(jQuery);(function(a){app.ToolboxView=Backbone.View.extend({tagName:"div",className:"widget",initialize:function(){this.template=_.template(a("#toolbox-template").html())},render:function(){this.$el.html(this.template(this.model.toJSON()));var b=new app.ToolsView({model:this.model.get("tools")});b.$el=this.$(".widget-content");b.render();return this}})})(jQuery);(function(a){app.ToolboxesView=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.empty();this.model.each(function(c){var b=new app.ToolboxView({model:c});this.$el.append(b.render().el)},this)}})})(jQuery);(function(a){app.XMLImporterView=Backbone.View.extend({id:"xml-importer",className:"modal fade",events:{"click #btnImport":"importXML","hidden.bs.modal":"teardown","change #js-upload-files":"uploadFile","load #js-upload-files":"importXML"},initialize:function(b){this.template=_.template(a("#xmlimporter-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:false,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()},uploadFile:function(c){var e=c.target.files[0];var b=new FileReader();var d=this;b.readAsText(e);b.onload=function(){a.ajax({url:"XMLImporter",type:"POST",data:b.result,contentType:"application/json; charset=UTF-8",complete:function(g,h,f){d.allowImport(g.status);d.validXML=b.result}})}},importXML:function(){var b=app.XMLParser;b.parseOMTGSchema(this.validXML);this.teardown()},allowImport:function(b){if(b==202){this.$("#btnImport").removeClass("disabled")}else{this.$("#btnImport").addClass("disabled")}}})})(jQuery);(function(a){app.NavbarView=Backbone.View.extend({events:{"click #btnImportXML":"importXML","click #btnExportXML":"exportXML","click #btnExportSQL":"exportSQL","click #btnExportPostgis":"exportPostgis","click #btnPrint":"print","click #btnAbout":"showAbout"},importXML:function(){if(app.canvas.get("diagrams").length>0){alert(app.msgs.NOT_EMPTY_PROJECT);return}new app.XMLImporterView()},exportXML:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var c=app.canvas.toXML();var b=new Blob([c]);saveAs(b,"OMTG.xml")},false)},exportSQL:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var b=app.canvas.toXML();a.ajax({url:"omtg2sql",type:"POST",data:b,contentType:"application/json; charset=UTF-8",success:function(g,h,f){var c=new Uint8Array(g.length);for(var e=0;e<g.length;e++){c[e]=g.charCodeAt(e)&255}var d=new Blob([c]);saveAs(d,"OMTG.zip")},error:function(e,c,d){alert("The request failed.")}})},false)},exportPostgis:function(){if(app.canvas.get("diagrams").length==0){alert(app.msgs.EMPTY_PROJECT);return}app.plumb.doWhileSuspended(function(){var b=app.canvas.toXML();a.ajax({url:"omtg2postgis",type:"POST",data:b,contentType:"application/json; charset=UTF-8",success:function(g,h,f){var c=new Uint8Array(g.length);for(var e=0;e<g.length;e++){c[e]=g.charCodeAt(e)&255}var d=new Blob([c]);saveAs(d,"OMTG.zip")},error:function(e,c,d){alert("The request failed.")}})},false)},print:function(){app.canvasView.print()},showAbout:function(){new app.AboutView()}})})(jQuery);(function(a){app.CanvasView=Backbone.View.extend({events:{click:"clicked"},initialize:function(){this.listenTo(this.model.get("diagrams"),"add",this.addOMTGDiagram);this.listenTo(this.model,"change:activeTool",this.setCursor)},clicked:function(d){var c=this.model.get("activeTool");if(c){if(c.get("model")=="omtgDiagram"){var b=new app.omtg.Diagram({type:c.get("name"),left:d.offsetX,top:d.offsetY});this.model.get("diagrams").add(b)}c.toggleActive();this.model.set("activeTool",null)}this.model.get("diagrams").unselectAll()},setCursor:function(){var b=this.model.get("activeTool");if(b&&b.get("model")=="omtgDiagram"){this.$el.css("cursor","copy")}else{this.$el.css("cursor","default")}},addOMTGDiagram:function(b){app.plumb.setSuspendDrawing(true);var c=new app.omtg.DiagramView({model:b});var d=c.render().el;this.$el.append(d);app.plumb.makeSource(d,{filter:function(){var e=app.canvas.get("activeTool");if(e&&e.get("model")=="omtgRelation"){return true}return false}});app.plumb.makeTarget(d);app.plumb.draggable(d,{containment:"#canvas",scroll:true,drag:function(g,f){if(a(".cartographic-square").length>0){app.plumb.repaintEverything()}}});app.plumb.setSuspendDrawing(false,true)},print:function(){}})})(jQuery);(function(a){app.AboutView=Backbone.View.extend({id:"welcome-modal",className:"modal fade",events:{"hidden.bs.modal":"teardown"},initialize:function(b){this.template=_.template(a("#about-template").html());this.render()},render:function(){this.$el.html(this.template());this.$el.modal({backdrop:"static",keyboard:true,show:true});return this},teardown:function(){this.$el.data("modal",null);this.remove()}})})(jQuery);jsPlumb.ready(function(){var g={strokeStyle:"black",lineWidth:2,outlineColor:"transparent",outlineWidth:4};var f={strokeStyle:"black",lineWidth:2,outlineColor:"transparent",outlineWidth:4,dashstyle:"4"};var c={lineWidth:4,strokeStyle:"#1e8151",outlineWidth:2,outlineColor:"white"};var b=[["Diamond",{length:35,width:18,location:35,paintStyle:{strokeStyle:"black",fillStyle:"white"}}]];var a=function(h){if(h=="generalization-disjoint-partial"){return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}]}if(h=="generalization-overlapping-partial"){return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}]}if(h=="generalization-disjoint-total"){return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}]}if(h=="generalization-overlapping-total"){return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]}};var e=function(h){if(h=="cartographic-generalization-overlapping"){return["Image",{src:"imgs/omtg/square-black.png",cssClass:"square-overlay"}]}if(h=="cartographic-generalization-disjoint"){return["Image",{src:"imgs/omtg/square-white.png",cssClass:"square-overlay"}]}};var d=function(i,h){return["Custom",{create:function(j){return $('<img class="cartographic-square" src="imgs/omtg/square-'+i+'.png" alt="'+i+' square" width="16px" height="16px" >')},id:"cartographic-square",cssClass:"cartographic-square",location:h}]};app.plumb=jsPlumb.getInstance({Anchor:"Continuous",ConnectionsDetachable:false,Connector:"Flowchart",Container:"canvas",DragOptions:{cursor:"pointer",zIndex:2000},Endpoint:"Blank",HoverPaintStyle:c});app.plumb.registerConnectionTypes({association:{paintStyle:g,overlays:[["Label",{label:"",location:0.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"",location:45,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"",location:-45,id:"cardinality-labelB",cssClass:"cardinality-label"}]],parameters:{minA:"",maxA:"",minB:"",maxB:""}},"spatial-association":{paintStyle:f,overlays:[["Label",{label:"Contains",location:0.5,id:"description-label",cssClass:"description-label"}],["Label",{label:"",location:45,id:"cardinality-labelA",cssClass:"cardinality-label"}],["Label",{label:"",location:-45,id:"cardinality-labelB",cssClass:"cardinality-label"}]],parameters:{minA:"",maxA:"",minB:"",maxB:""}},aggregation:{paintStyle:g,overlays:b},"spatial-aggregation":{paintStyle:f,overlays:b},"generalization-disjoint-partial":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:g,parameters:{participation:"partial",disjointness:"disjoint"}},"generalization-overlapping-partial":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:g,parameters:{participation:"partial",disjointness:"overlapping"}},"generalization-disjoint-total":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:g,parameters:{participation:"total",disjointness:"disjoint"}},"generalization-overlapping-total":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:g,parameters:{participation:"total",disjointness:"overlapping"}},"generalization-leg":{connector:["Flowchart",{stub:[50,30],alwaysRespectStubs:true}],paintStyle:g},"arc-network":{connector:"Straight",paintStyle:f,overlays:[["Label",{label:"network",location:0.5,id:"description-label",cssClass:"arc-network-label"}]]},"arc-network-sibling":{connector:"Straight",paintStyle:f},"arc-network-self":{connector:["Flowchart",{stub:[50,50],alwaysRespectStubs:true}],paintStyle:f,overlays:[["Label",{label:"network",location:0.4,id:"description-label",cssClass:"arc-network-label"}]]},"arc-network-sibling-self":{connector:["Flowchart",{stub:[25,25],alwaysRespectStubs:true}],paintStyle:f},"cartographic-generalization-disjoint":{connector:["Flowchart",{stub:[70,50],alwaysRespectStubs:true}],paintStyle:f,overlays:[d("white",70),["Label",{label:"scale",location:0.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"disjoint"}},"cartographic-generalization-overlapping":{connector:["Flowchart",{stub:[70,50],alwaysRespectStubs:true}],paintStyle:f,overlays:[d("black",70),["Label",{label:"scale",location:0.5,id:"cartographic-label",cssClass:"cartographic-label"}]],parameters:{disjointness:"overlapping"}},"cartographic-leg":{connector:["Flowchart",{stub:[0,50],alwaysRespectStubs:true}],paintStyle:f}});app.plumb.bind("connectionDrag",function(h){var i=app.canvas.get("activeTool");if(i&&i.get("model")=="omtgRelation"){h.setType(i.get("name"));return}if(h.source.classList.contains("cartographic-square")){h.setType("cartographic-leg")}});app.plumb.bind("connection",function(n,h){var m=n.connection.getType()[0];switch(m){case"arc-network":if(n.connection.sourceId==n.connection.targetId){app.plumb.detach(n.connection);var j=app.plumb.connect({source:n.connection.sourceId,target:n.connection.targetId,anchors:[[0.35,1,0,1],[1,0.5,1,0]],type:"arc-network-self",fireEvent:false});var l=app.plumb.connect({source:n.connection.sourceId,target:n.connection.targetId,anchors:[[0.5,1,0,1],[1,0.75,1,0]],type:"arc-network-sibling-self",parameters:{sibling:j},fireEvent:false});j.setParameter("sibling",l)}else{var l=app.plumb.connect({source:n.connection.sourceId,target:n.connection.targetId,type:"arc-network-sibling",parameters:{sibling:n.connection},fireEvent:false});n.connection.setParameter("sibling",l)}break;case"generalization-disjoint-partial":case"generalization-disjoint-total":case"generalization-overlapping-partial":case"generalization-overlapping-total":var i=n.connection.getParameter("participation");var k=n.connection.getParameter("disjointness");app.plumb.detach(n.connection);var o=app.plumb.addEndpoint(n.connection.sourceId,{anchor:[0.5,1.2,0,1],connectionType:"generalization-leg",endpoint:a(m),isSource:true,isTarget:false,maxConnections:100,uniqueEndpoint:true,parameters:{participation:i,disjointness:k}});var j=app.plumb.connect({anchors:["Bottom","Top"],source:o,target:n.connection.targetId,type:m,fireEvent:false});j.removeAllOverlays();break;case"generalization-leg":n.connection.endpoints[1].setAnchor("Top");break;case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":app.plumb.detach(n.connection);var j=app.plumb.connect({source:n.connection.sourceId,target:n.connection.targetId,anchors:["Bottom","Top"],type:m,fireEvent:false});app.plumb.makeSource(j.getOverlay("cartographic-square").getElement());break;case"cartographic-leg":n.connection.endpoints[1].setAnchor("Top");break}});app.plumb.bind("beforeDrop",function(k){var i=k.connection.getType()[0];if(i!="arc-network"&&k.sourceId==k.targetId){return false}var h=app.canvas.get("diagrams").get(k.sourceId,"type");var j=app.canvas.get("diagrams").get(k.targetId,"type");switch(i){case"generalization-disjoint-partial":case"generalization-overlapping-partial":case"generalization-disjoint-total":case"generalization-overlapping-total":return h==j;case"aggregation":return(h=="conventional")||(j=="conventional");case"cartographic-generalization-disjoint":case"cartographic-generalization-overlapping":return(h=="conventional")&&(j!="conventional");case"cartographic-leg":return j!="conventional";case"spatial-association":case"spatial-aggregation":return(h!="conventional")&&(j!="conventional");case"arc-network":return(h==j&&(h=="node"||h=="bi-line"||h=="un-line"))||(h=="node"&&(j=="bi-line"||j=="un-line"))||(j=="node"&&(h=="bi-line"||h=="un-line"))}return true});app.plumb.bind("dblclick",function(j,h){var l=j;if(j instanceof jsPlumb.Overlays.Label){l=j.component}var i=l.getType()[0];if(i=="arc-network-sibling"||i=="arc-network-sibling-self"){l=l.getParameter("sibling")}if(i=="aggregation"||i=="spatial-aggregation"||i=="cartographic-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){app.plumb.detach(l)}}else{if(i=="generalization-disjoint-partial"||i=="generalization-disjoint-total"||i=="generalization-overlapping-partial"||i=="generalization-overlapping-total"){if(confirm(app.msgs.DELETE_CONNECTION)){var k=l.endpoints[0];app.plumb.detach(l);if(k.getAttachedElements().length==0){app.plumb.deleteEndpoint(k)}else{k.getAttachedElements()[0].setType(i);k.getAttachedElements()[0].removeAllOverlays()}}}else{if(i=="generalization-leg"){if(confirm(app.msgs.DELETE_CONNECTION)){var k=l.endpoints[0];app.plumb.detach(l);if(k.getAttachedElements().length==0){app.plumb.deleteEndpoint(k)}}}else{new app.omtg.ConnectionEditorView({connection:l})}}}})});"use strict";app.XMLParser={parseOMTGSchema:function(a){app.plumb.setSuspendDrawing(true);var d=new DOMParser();var c=d.parseFromString(a,"text/xml");this.diagramMap={};var e=c.getElementsByTagName("classes")[0].childNodes;var b=c.getElementsByTagName("relationships")[0].childNodes;this.parseOMTGDiagrams(e);this.parseOMTGConnections(b);app.plumb.setSuspendDrawing(false,true)},parseOMTGDiagrams:function(d){for(var b=0;b<d.length;b++){var c=d.item(b);var a=this.parseOMTGDiagram(c);app.canvas.get("diagrams").add(a)}},parseOMTGDiagram:function(d){var c=d.childNodes;var a=new app.omtg.Diagram();for(var b=0;b<c.length;b++){switch(c.item(b).nodeName){case"name":a.set("name",c.item(b).firstChild.nodeValue);break;case"top":a.set("top",parseFloat(c.item(b).firstChild.nodeValue));break;case"left":a.set("left",parseFloat(c.item(b).firstChild.nodeValue));break;case"type":a.set("type",c.item(b).firstChild.nodeValue);break;case"attributes":a.set("attributes",this.parseOMTGAttributes(c.item(b)));break}}this.diagramMap[a.get("name")]=a.get("id");return a},parseOMTGAttributes:function(d){var c=d.childNodes;var a=new app.omtg.Attributes();for(var b=0;b<c.length;b++){var e=this.parseOMTGAttribute(c.item(b));a.add(e)}return a},parseOMTGAttribute:function(c){var b=c.childNodes;var d=new app.omtg.Attribute();for(var a=0;a<b.length;a++){switch(b.item(a).nodeName){case"id":d.set("id",b.item(a).firstChild.nodeValue);break;case"name":d.set("name",b.item(a).firstChild.nodeValue);break;case"type":d.set("type",b.item(a).firstChild.nodeValue);break;case"default":d.set("defaultValue",b.item(a).firstChild.nodeValue);break;case"key":d.set("isKey",b.item(a).firstChild.nodeValue);break;case"length":d.set("length",b.item(a).firstChild.nodeValue);break;case"scale":d.set("scale",b.item(a).firstChild.nodeValue);break;case"size":d.set("size",b.item(a).firstChild.nodeValue);break;case"not-null":d.set("isNotNull",b.item(a).firstChild.nodeValue);break;case"domain":d.set("domain",this.parseOMTGAttributeDomain(b.item(a)));break}}return d},parseOMTGAttributeDomain:function(a){return null},parseOMTGConnections:function(c){for(var a=0;a<c.length;a++){var b=c.item(a);this.parseOMTGConnection(b)}},parseOMTGConnection:function(a){switch(a.nodeName){case"conventional":var k=this.getValue(a.childNodes[0].firstChild);var b=a.childNodes[1].firstChild.nodeValue;var f=a.childNodes[3].firstChild.nodeValue;var s=a.childNodes[2];var p=a.childNodes[4];var e=app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],type:"association"});e.getOverlay("description-label").setLabel(k);this.parseOMTGConnectionCardinality(s,e,"A");this.parseOMTGConnectionCardinality(p,e,"B");break;case"topological":var k=this.getValue(a.childNodes[0].firstChild.firstChild);var b=a.childNodes[1].firstChild.nodeValue;var f=a.childNodes[3].firstChild.nodeValue;var s=a.childNodes[2];var p=a.childNodes[4];var e=app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],type:"spatial-association"});e.getOverlay("description-label").setLabel(k);this.parseOMTGConnectionCardinality(s,e,"A");this.parseOMTGConnectionCardinality(p,e,"B");break;case"conventional-aggregation":var b=a.childNodes[0].firstChild.nodeValue;var f=a.childNodes[1].firstChild.nodeValue;app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],type:"aggregation"});break;case"spatial-aggregation":var b=a.childNodes[0].firstChild.nodeValue;var f=a.childNodes[1].firstChild.nodeValue;app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],type:"spatial-aggregation"});break;case"network":var k=this.getValue(a.childNodes[0].firstChild);var b=a.childNodes[1].firstChild.nodeValue;var f=a.childNodes[2].firstChild.nodeValue;var c="arc-network";var q="arc-network-sibling";var g=["Continuous","Continuous"];var m=["Continuous","Continuous"];if(b==f){c="arc-network-self";q="arc-network-sibling-self";g=[[0.35,1,0,1],[1,0.5,1,0]];m=[[0.5,1,0,1],[1,0.75,1,0]]}var e=app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],anchors:g,type:c,fireEvent:false});var o=app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],anchors:m,type:q,parameters:{sibling:e},fireEvent:false});e.setParameter("sibling",o);e.getOverlay("description-label").setLabel(k);break;case"conceptual-generalization":var b=a.childNodes[0].firstChild.nodeValue;var j=a.childNodes[2].firstChild.nodeValue;var f=a.childNodes[3].childNodes[0].firstChild.nodeValue;var r=a.childNodes[3].childNodes;var e=app.plumb.connect({source:this.diagramMap[b],target:this.diagramMap[f],anchors:["Bottom","Top"],type:"cartographic-generalization-"+j,fireEvent:false});var h=e.getOverlay("cartographic-square").getElement();app.plumb.makeSource(h);for(var l=1;l<r.length;l++){app.plumb.connect({source:h,target:this.diagramMap[r[l].firstChild.nodeValue],type:"cartographic-leg"})}break;case"generalization":var b=a.childNodes[0].firstChild.nodeValue;var t=a.childNodes[1].firstChild.nodeValue;var j=a.childNodes[2].firstChild.nodeValue;var r=a.childNodes[3].childNodes;var c="generalization-"+j+"-"+t;var n=function(i){if(i=="generalization-disjoint-partial"){return["Image",{src:"imgs/omtg/triangle-white.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-overlapping-partial"){return["Image",{src:"imgs/omtg/triangle-black.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-disjoint-total"){return["Image",{src:"imgs/omtg/triangle-circle-white.png",cssClass:"triangle-endpoint"}]}if(i=="generalization-overlapping-total"){return["Image",{src:"imgs/omtg/triangle-circle-black.png",cssClass:"triangle-endpoint"}]}};var d=app.plumb.addEndpoint(this.diagramMap[b],{anchor:[0.5,1.2,0,1],connectionType:"generalization-leg",endpoint:n(c),isSource:true,isTarget:false,maxConnections:100,uniqueEndpoint:true,parameters:{participation:t,disjointness:j}});for(var l=0;l<r.length;l++){app.plumb.connect({source:d,target:this.diagramMap[r[l].firstChild.nodeValue],type:"generalization-leg"})}break}},parseOMTGConnectionCardinality:function(e,b,d){if(d!="A"&&d!="B"){return}var c="",a="",f="";c=this.getValue(e.childNodes[0].firstChild);a=this.getValue(e.childNodes[1].firstChild);if(c==""&&a==""){f=""}else{if(c!=""&&a!=""){f=c+".."+a}else{f=c+""+a}}b.getOverlay("cardinality-label"+d).setLabel(f);b.setParameter("min"+d,c);b.setParameter("max"+d,a)},getValue:function(a){if(a){return a.nodeValue}else{return""}}};